---
apiVersion: v1
kind: ConfigMap
metadata:
  name: test
  labels:
    opa.stackable.tech/bundle: "true"
data:
  test.rego: |
    package test

    userInfo(username) := http.send({"method": "POST", "url": "http://127.0.0.1:9476/user", "body": {"username": username}, "headers": {"Content-Type": "application/json"}, "raise_error": true}).body
    currentUserInfo := userInfo(input.username)
---
apiVersion: opa.stackable.tech/v1alpha1
kind: OpaCluster
metadata:
  name: test-opa
spec:
  image:
    productVersion: "{{ test_scenario['values']['opa-latest'] }}"
  clusterConfig:
    userInfo:
      backend:
        keycloak:
          url: http://keycloak:8080
          credentialsSecretName: opa-keycloak
          adminRealm: master
          userRealm: master
          clientId: admin-cli
{% if lookup('env', 'VECTOR_AGGREGATOR') %}
    vectorAggregatorConfigMapName: vector-aggregator-discovery
{% endif %}
  servers:
    config:
      logging:
        enableVectorAgent: {{ lookup('env', 'VECTOR_AGGREGATOR') | length > 0 }}
    roleGroups:
      default: {}
---
apiVersion: v1
kind: Secret
metadata:
  name: opa-keycloak
stringData:
  username: admin
  password: admin
