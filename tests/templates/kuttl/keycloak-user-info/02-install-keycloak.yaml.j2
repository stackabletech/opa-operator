---
apiVersion: kuttl.dev/v1beta1
kind: TestStep
commands:
  - script: |
      kubectl apply -n $NAMESPACE -f - <<EOFF
      ---
      apiVersion: v1
      kind: Service
      metadata:
        name: keycloak
        labels:
          app: keycloak
      spec:
        ports:
          - name: https
            port: 8443
            targetPort: 8443
        selector:
          app: keycloak
      ---
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: keycloak
        labels:
          app: keycloak
      spec:
        replicas: 1
        selector:
          matchLabels:
            app: keycloak
        template:
          metadata:
            labels:
              app: keycloak
          spec:
            containers:
              - name: keycloak
                image: quay.io/keycloak/keycloak:{{ test_scenario['values']['keycloak'] }}
                args:
                  - start
                  - --hostname-strict=false
                  - --https-key-store-file=/tls/keystore.p12
                  - --https-key-store-password=changeit
                env:
                  - name: KEYCLOAK_ADMIN
                    value: admin
                  - name: KEYCLOAK_ADMIN_PASSWORD
                    valueFrom:
                      secretKeyRef:
                        name: keycloak-admin-credentials
                        key: admin
                ports:
                  - name: https
                    containerPort: 8443
                readinessProbe:
                  httpGet:
                    scheme: HTTPS
                    path: /realms/master
                    port: https
                resources:
                  limits:
                    cpu: 1
                    memory: 1Gi
                  requests:
                    cpu: 200m
                    memory: 1Gi
                volumeMounts:
                  - name: data
                    mountPath: /opt/keycloak/data/
                  - name: tls
                    mountPath: /tls/
            securityContext:
              fsGroup: 1000
              runAsGroup: 1000
              runAsUser: 1000
            volumes:
              - name: data
                emptyDir: {}
              - name: tls
                ephemeral:
                  volumeClaimTemplate:
                    metadata:
                      annotations:
                        secrets.stackable.tech/class: tls
                        secrets.stackable.tech/format: tls-pkcs12
                        secrets.stackable.tech/format.compatibility.tls-pkcs12.password: changeit
                        secrets.stackable.tech/scope: service=keycloak,node
                    spec:
                      storageClassName: secrets.stackable.tech
                      accessModes:
                        - ReadWriteOnce
                      resources:
                        requests:
                          storage: "1"
      ---
      apiVersion: v1
      kind: Secret
      metadata:
        name: keycloak-admin-credentials
      stringData:
        admin: "adminadmin"
      EOFF
